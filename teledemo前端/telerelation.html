<!DOCTYPE html>
<html>
<link rel="stylesheet" href="./layui/css/layui.css" media="all">
<link rel="stylesheet" href="./css/font.css">
<link rel="stylesheet" href="./css/xadmin.css">
<head>
	<meta charset="UTF-8">
	<title>关联图</title>
</head>

<body>
<div id="main" style="width: 1200px; height: 700px"></div>
<div id="ss"></div>
<script src="http://echarts.baidu.com/build/dist/echarts.js"></script>
<script src="./layui/layui.js" charset="utf-8"></script>
<script src="./js/jquery.min.js"></script>
<script type="text/javascript">
	var nodes = [];
	var links = [];
	$.ajax({
		url: 'http://localhost:10002/v1/userRelationInfo',
		type: "GET",
		xhrFields: {
			withCredentials: true //允许跨域认证
		},
		success: function (data) {

			for(i = 0 ; i < data.length; i++){
				if(data[i].status == "1"){
					nodesCategory = 0;
					symbolsize = 60;
					nodesLabel = "确诊" + ( i + 1);
				}
				else if(data[i].status == "2"){
					nodesCategory = 1;
					symbolsize = 40;
					nodesLabel = "密接" + ( i + 1);
				}
				else if(data[i].status == "3"){
					nodesCategory = 2;
					symbolsize = 20;
					nodesLabel = "次密接" +( i + 1);
				}
				else if(data[i].status == "0"){
					nodesCategory = 3;
					symbolsize = 15;
					nodesLabel = "正常" + ( i + 1);
				}
				nodesId = data[i].userId;
				nodesName = data[i].userId + "";

				var node = 	{
					id: nodesId,
					category: nodesCategory,
					name: nodesName,
					label: nodesLabel,
					symbolSize: symbolsize,
					ignore: false,
					flag: true
				}
				nodes[i] = node;
			}
			for(i = 0; i < data.length ; i++){

				linksSource = data[i].userId - 1;
				linksTarget = data[i].relation - 1;


				var link = {
					source: linksSource,
					target: linksTarget
				}
				links[i] = link;
			}
		},
		error: function (data) {
		}
	})
	require.config({

		paths: {
			echarts: 'http://echarts.baidu.com/build/dist'
		}
	});


	require(["echarts", "echarts/chart/force"], function(ec) {

		var myChart = ec.init(document.getElementById('main'), 'macarons');
		var option = {
			tooltip: {
				show: false
			},
			series: [{
				type: 'force',
				name: "Force tree",
				itemStyle: {
					normal: {
						label: {
							show: true
						},
						nodeStyle: {
							brushType: 'both',
							borderColor: 'rgba(0,255,255,0.4)',
							borderWidth: 1
						}
					}
				},
				categories: [{
					name: '确诊'
				}, {
					name: '密切接触者'
				}, {
					name: '次密切接触者'
				}, {
					name: '正常'
				}],
                nodes:nodes,
                links:links,
			}]
		};
		myChart.setOption(option);
		var ecConfig = require('echarts/config');

		function openOrFold(param) {
			var option = myChart.getOption();
			var nodesOption = option.series[0].nodes;
			var linksOption = option.series[0].links;
			var data = param.data;
			var linksNodes = [];

			var categoryLength = option.series[0].categories.length;

			if (data != null && data != undefined) {
				if (data.flag) {

					for (var m in linksOption) {

						if (linksOption[m].target == data.id) {
							linksNodes.push(linksOption[m].source);
						}
					}
					if (linksNodes != null && linksNodes != undefined) {
						for (var p in linksNodes) {
							nodesOption[linksNodes[p]].ignore = false;
							nodesOption[linksNodes[p]].flag = true;
						}
					}
					nodesOption[data.id].flag = false;
					myChart.setOption(option);
				} else {

					for (var m in linksOption) {

						if (linksOption[m].target == data.id) {
							linksNodes.push(linksOption[m].source);
						}
						if (linksNodes != null && linksNodes != undefined) {
							for (var n in linksNodes) {
								if (linksOption[m].target == linksNodes[n]) {
									linksNodes.push(linksOption[m].source);
								}
							}
						}
					}
					if (linksNodes != null && linksNodes != undefined) {
						for (var p in linksNodes) {
							nodesOption[linksNodes[p]].ignore = true;
							nodesOption[linksNodes[p]].flag = true;
						}
					}
					nodesOption[data.id].flag = true;
					myChart.setOption(option);
				}
			}
		}
		myChart.on(ecConfig.EVENT.CLICK, openOrFold);

	});
</script>

</body>

</html>